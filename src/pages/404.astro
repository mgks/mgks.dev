---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Get all valid tags to display suggestions
const allPosts = await getCollection('blog');
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))].sort();
---

<Layout title="404" description="Page not found">

    <div style="margin-top:8em; min-height: 50vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
        
        <!-- 1. LOADING STATE (Visible by default via JS logic below) -->
        <div id="loading-state" style="display: block;">
            <div class="loading-spinner"></div>
            <p class="text-muted font-mono">Checking paths...</p>
        </div>

        <!-- 2. ACTUAL 404 CONTENT (Hidden by default) -->
        <div id="error-content" style="display: none; flex-direction: column; align-items: center;">
            <h1 class="hero-title" style="font-size: 8rem; margin-bottom: 0; color: var(--accent);">404</h1>
            <p id="error-title" style="font-family: var(--font-mono); font-size: 1.5rem; margin-bottom: 2rem;">Page not found</p>

            <!-- Tag Suggestion Box (Hidden unless tag error) -->
            <div id="tag-box" class="hidden" style="flex-direction: column; gap: 1rem; align-items: center; max-width: 40rem; margin-bottom: 2rem;">
                <p class="text-muted">
                    We haven't written about this tag yet, but here are some popular topics:
                </p>
                <div class="filter-group">
                    {allTags.slice(0, 10).map(tag => (
                        <a href={`/tags/${tag}`} class="filter-btn">{tag}</a>
                    ))}
                </div>
            </div>

            <p id="default-msg" style="color: var(--text-muted); max-width: 20rem; margin-bottom: 2rem;">
                The page you are looking for might have been moved, renamed, or temporarily unavailable.
            </p>
            
            <a href="/" class="page-btn">Go Home</a>
        </div>

        <!-- 3. REDIRECT MESSAGE (Hidden by default) -->
        <div id="redirect-msg" class="hidden">
            <h2 class="hero-title" style="font-size: 3rem;">Found it!</h2>
            <p class="text-accent animate-pulse font-mono">Redirecting you now...</p>
        </div>

    </div>

    <script is:inline>
        (async () => {
            const path = window.location.pathname;
            const cleanPath = path.replace(/^\/|\/$/g, ''); // Remove leading/trailing slashes
            const parts = cleanPath.split('/');

            const loading = document.getElementById('loading-state');
            const errorContent = document.getElementById('error-content');
            const redirectMsg = document.getElementById('redirect-msg');
            const tagBox = document.getElementById('tag-box');
            const errorTitle = document.getElementById('error-title');
            const defaultMsg = document.getElementById('default-msg');

            function show404() {
                if (loading) loading.style.display = 'none';
                if (errorContent) errorContent.style.display = 'flex';
            }

            function showRedirect() {
                if (loading) loading.style.display = 'none';
                if (redirectMsg) redirectMsg.classList.remove('hidden');
            }

            // --- CASE 1: TAGS ---
            // Check if path starts with 'tags'
            if (parts[0] === 'tags') {
                show404();
                if (errorTitle) errorTitle.innerText = "Unknown Tag";
                if (defaultMsg) defaultMsg.style.display = 'none';
                if (tagBox) {
                    tagBox.classList.remove('hidden');
                    tagBox.style.display = 'flex';
                }
                return;
            }

            // --- CASE 2: BLOG POST MIGRATION ---
            // Only try to fetch if it looks like a blog slug
            // Conditions: 
            // 1. Not a file extension (e.g. .css, .js)
            // 2. Either starts with 'blog' OR is just a slug at root level (depending on your structure)
            const possibleSlug = parts[parts.length - 1];
            const isLikeSlug = !possibleSlug.includes('.') && possibleSlug.length > 3;

            if (isLikeSlug) {
                try {
                    const response = await fetch('/posts.json');
                    if (!response.ok) throw new Error('No index');
                    
                    const posts = await response.json();

                    // Find match: new slug ends with old slug
                    const match = posts.find(p => p.slug.endsWith(possibleSlug) || p.slug === possibleSlug);

                    if (match) {
                        showRedirect();
                        setTimeout(() => {
                            window.location.href = `/blog/${match.slug}`;
                        }, 500);
                        return;
                    }
                } catch (e) {
                    console.log("Redirect check failed or no match");
                }
            }

            // --- CASE 3: STANDARD 404 ---
            show404();
        })();
    </script>
</Layout>